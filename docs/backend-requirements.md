# 后端系统需求文档

## 1. 系统概述

### 1.1 项目背景
钓鱼天气社交应用需要一个高性能、可扩展的后端服务来支持用户认证、钓点分享、鱼获展示、社区互动等核心功能。后端系统将采用Go语言开发，提供RESTful API接口，支持高并发访问和数据持久化存储。

### 1.2 系统目标
- 提供稳定可靠的用户认证和授权服务
- 支持地理位置相关的钓点管理和搜索
- 实现鱼获分享和社区互动功能
- 保证系统高可用性和数据安全性
- 支持水平扩展和性能优化

## 2. 功能需求

### 2.1 用户管理模块

#### 2.1.1 用户注册
**需求描述**: 新用户可以通过邮箱进行注册
**输入参数**:
- 邮箱地址 (必填，格式验证)
- 密码 (必填，长度≥8位，包含字母和数字)
- 昵称 (必填，长度2-20位)
- 头像URL (可选)
- 个人简介 (可选，长度≤500字符)

**业务规则**:
- 邮箱地址必须唯一
- 密码需要加密存储 (bcrypt)
- 注册成功后自动生成用户ID
- 发送欢迎邮件 (可选)

**输出结果**:
- 用户ID
- 访问令牌 (JWT)
- 用户信息

#### 2.1.2 用户登录
**需求描述**: 已注册用户可以通过邮箱和密码登录
**输入参数**:
- 邮箱地址
- 密码

**业务规则**:
- 验证邮箱和密码匹配
- 生成JWT访问令牌 (有效期24小时)
- 记录登录时间和IP地址
- 支持记住登录状态

**输出结果**:
- 访问令牌 (JWT)
- 刷新令牌 (可选，有效期7天)
- 用户信息

#### 2.1.3 用户信息管理
**需求描述**: 用户可以查看和修改个人资料
**功能点**:
- 获取用户信息
- 更新用户资料 (昵称、头像、简介)
- 修改密码 (需要验证原密码)
- 重置密码 (通过邮箱验证)

### 2.2 钓点管理模块

#### 2.2.1 钓点创建
**需求描述**: 用户可以分享钓鱼地点
**输入参数**:
- 钓点名称 (必填，长度≤50字符)
- 经度 (必填，-180到180)
- 纬度 (必填，-90到90)
- 描述 (可选，长度≤1000字符)
- 是否公开 (默认公开)

**业务规则**:
- 验证坐标有效性
- 同一用户不能创建重复钓点 (距离<100米)
- 记录创建时间和用户信息
- 支持图片上传 (最多5张)

#### 2.2.2 钓点搜索
**需求描述**: 根据地理位置搜索附近钓点
**输入参数**:
- 中心点经度
- 中心点纬度
- 搜索半径 (默认10km，最大100km)
- 搜索关键词 (可选)
- 分页参数

**业务规则**:
- 使用Haversine公式计算距离
- 按距离排序 (最近优先)
- 支持关键词搜索 (名称、描述)
- 分页显示结果

**输出结果**:
- 钓点列表 (包含距离信息)
- 总数量
- 分页信息

#### 2.2.3 钓点详情
**需求描述**: 查看钓点详细信息
**输出结果**:
- 钓点基本信息
- 创建者信息
- 相关图片
- 距离信息 (如果提供用户位置)

### 2.3 鱼获分享模块

#### 2.3.1 鱼获发布
**需求描述**: 用户可以分享钓鱼成果
**输入参数**:
- 鱼类名称 (必填)
- 重量 (可选，单位：kg)
- 长度 (可选，单位：cm)
- 描述 (可选，长度≤1000字符)
- 图片 (必填，至少1张，最多9张)
- 钓点信息 (可选，关联现有钓点或新钓点)
- 是否公开 (默认公开)

**业务规则**:
- 图片自动压缩 (最大2MB/张)
- 支持多种图片格式 (JPEG, PNG, WebP)
- 记录发布时间
- 支持地理位置标记

#### 2.3.2 鱼获浏览
**需求描述**: 浏览社区鱼获分享
**查询参数**:
- 排序方式 (最新、最热、附近)
- 分页参数
- 用户ID (可选，查看特定用户)
- 地理位置 (可选，附近鱼获)

**输出结果**:
- 鱼获列表
- 点赞数、评论数
- 发布者信息
- 分页信息

#### 2.3.3 互动功能
**点赞功能**:
- 用户可以点赞/取消点赞鱼获
- 防止重复点赞
- 实时更新点赞数

**评论功能**:
- 用户可以对鱼获进行评论
- 支持评论回复 (二级评论)
- 评论长度限制 (≤500字符)
- 支持删除自己的评论

### 2.4 文件管理模块

#### 2.4.1 图片上传
**需求描述**: 支持用户上传图片
**业务规则**:
- 自动图片压缩 (质量80%，最大尺寸1920x1080)
- 文件大小限制 (单张≤5MB)
- 格式验证 (JPEG, PNG, WebP)
- 生成缩略图 (300x300)
- 安全扫描 (防止恶意文件)

**输出结果**:
- 原始图片URL
- 缩略图URL
- 图片尺寸信息

## 3. 非功能需求

### 3.1 性能需求
- API响应时间: 平均<200ms，95%<500ms
- 并发用户支持: 1000+ 同时在线
- 图片上传速度: 1MB<3秒 (正常网络)
- 数据库查询优化: 主要查询<100ms

### 3.2 可用性需求
- 系统可用性: 99.9% (年停机时间<8.76小时)
- 故障恢复时间: <30分钟
- 数据备份: 每日自动备份，保留30天
- 容灾能力: 支持主从切换

### 3.3 安全需求
- 数据加密: 敏感数据AES-256加密
- 传输安全: HTTPS/TLS 1.3
- 认证安全: JWT + 刷新令牌机制
- 输入验证: 防止SQL注入、XSS攻击
- 访问控制: 基于角色的权限管理
- 审计日志: 记录关键操作

### 3.4 扩展性需求
- 水平扩展: 支持微服务架构
- 数据库分片: 支持按用户ID分片
- 缓存策略: Redis集群支持
- 负载均衡: 支持多实例部署

### 3.5 兼容性需求
- API版本管理: 支持多版本并存
- 向后兼容: 新版本兼容旧客户端
- 数据迁移: 支持数据结构升级

## 4. 技术约束

### 4.1 开发语言
- 后端语言: Go 1.21+
- 框架: Gin (Web框架)
- 数据库: MySQL 8.0+
- 缓存: Redis 7.0+

### 4.2 部署环境
- 操作系统: Linux (Ubuntu 20.04+)
- 容器化: Docker + Kubernetes
- 反向代理: Nginx
- 监控: Prometheus + Grafana

### 4.3 第三方服务
- 云存储: AWS S3 或 阿里云OSS
- CDN: 支持图片分发
- 邮件服务: SendGrid 或 阿里云邮件推送
- 短信服务: Twilio 或 阿里云短信

## 5. 数据需求

### 5.1 数据存储
- 用户数据: 用户信息、认证数据
- 钓点数据: 地理位置、描述信息
- 鱼获数据: 图片、描述、互动数据
- 评论数据: 评论内容、层级关系

### 5.2 数据量估算
- 用户数据: 10万用户，每用户1KB = 100MB
- 钓点数据: 50万钓点，每钓点2KB = 1GB
- 鱼获数据: 100万条，每条5KB = 5GB
- 图片存储: 平均2MB/张，100万张 = 2TB

### 5.3 数据保留策略
- 用户数据: 永久保留 (注销用户标记删除)
- 钓点数据: 永久保留
- 鱼获数据: 永久保留
- 评论数据: 永久保留
- 日志数据: 保留90天
- 备份数据: 保留30天

## 6. 接口规范

### 6.1 RESTful设计原则
- 资源导向的URL设计
- HTTP动词的正确使用
- 状态码的规范使用
- 统一的响应格式

### 6.2 认证机制
- JWT Bearer Token
- 刷新令牌机制
- API密钥管理

### 6.3 响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": "2024-01-01T00:00:00Z"
}
```

### 6.4 错误处理
```json
{
  "code": 400,
  "message": "Invalid request parameter",
  "error": "email format invalid",
  "timestamp": "2024-01-01T00:00:00Z"
}
```

## 7. 监控需求

### 7.1 性能监控
- API响应时间监控
- 数据库查询性能
- 系统资源使用率
- 错误率和异常监控

### 7.2 业务监控
- 用户注册/登录统计
- 钓点创建/搜索统计
- 鱼获发布/互动统计
- 用户活跃度分析

### 7.3 告警机制
- 系统异常告警
- 性能指标告警
- 业务指标告警
- 安全事件告警